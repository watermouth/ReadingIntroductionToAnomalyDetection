# 正規分布に従うデータからの異常検知

正規分布に従うデータに対する異常検知理論として、ホテリング(Hotelling)理論というものがある。

carパッケージのDavisデータ

> Self-Reports of Height and Weight
>
> The Davis data frame has 200 rows and 5 columns. The subjects were men and women engaged in regular exercise. There are some missing data.

を題材として、異常検知、特にデータ・クレンジングをやってみよう。

## 1変量正規分布に基づく異常検知

### Davis : 体重の分布
まずは1次元データで考える。

```{r}
library(car)
data(Davis)
hist(Davis$weight, breaks=10)
```

正規分布のようには見えないが、近似出来なくもないだろう。

### 分布の推定
1次元の正規分布と見做すのであれば、平均・分散が分かれば良い。
最尤推定量を用いることにしよう。

```{r}
mu <- mean(Davis$weight) 
s2 <- mean((Davis$weight - mu)^2)
c(mu, s2)

hist(Davis$weight, breaks=10, freq = F)
x <- seq(1, max(Davis$weight)+10)
lines(x, dnorm(x = x, mean = mu, sd = sqrt(s2)), col="red")
```

* 全てのデータを使って推定したので、全てのデータを正常なデータと見做したことになる。
* 実際には異常なデータが含まれていると思っているが、異常データが少なければ
分布の推定上は概ね正常な分布の推定になっていると考えてよいだろう。

### 異常度(Anomaly Score)
各データの異常度を計算してみよう。  
ただし本質的でない部分を除外するため、$-\ln p(x)$そのものではなく、$x$とデータ$D$に依存する部分だけを抜き出した定義とする。

```{r, fig.height=3, fig.width=7}
a <- (Davis$weight - mu) ^ 2 / s2
th <- qchisq(0.99, 1) # 1次のカイ二乗分布の99%点
plot(a, xlab="index", ylab="anomaly score")
lines(0:200,rep(th,length(0:200)),col="red",lty=2)
```

* 異常度は近似的にカイ二乗分布に従うことが示される。計算すると出るが、この辺りの結果をホテリング理論というらしい。
* 分布推定に用いたデータに対して異常度を計算するのは、厳密には正しくないが、
異常なデータが少ないならば概ね問題ないだろう。
* 厳密にやりたければ、leave-one-out（1つのデータ以外で分布推定して、そのデータの異常度を求める）でやればよい。

### 異常な点
閾値を越えた点が2つあるが、1つは身長と体重の入力を逆にしたものであるらしい。
2つめはその手の異常ではなさそうだ。

```{r}
ap <- which(a > th)
Davis[ap,]
```

* 機械的なデータクレンジング手続きとしては、これらを除去してしまえばよい。
* が、入力ミスでないものも含むのが気になる。閾値を変えるのも手ではある。

### 最も異常な点を除いてから再度異常度計算
もっとも異常な点`r ap[1]`を除いてみる。

```{r }
mu.old <- mu
s2.old <- s2
Davis2 <- Davis[-ap[1],]
mu <- mean(Davis2$weight)
s2 <- mean((Davis2$weight - mu)^2)
```

* 除去前 : `r paste0("mu = ", format(mu.old, digits=3), ", s2 = ", format(s2.old, digits=3))`
* 除去後 : `r paste0("mu = ", format(mu, digits=3), ", s2 = ", format(s2, digits=3))`

```{r}
hist(Davis$weight, breaks=10, freq = F)
x <- seq(1, max(Davis$weight)+10)
lines(x, dnorm(x = x, mean = mu.old, sd = sqrt(s2.old)), col="red")
lines(x, dnorm(x = x, mean = mu, sd = sqrt(s2)), col="blue")
legend("topright", legend = c("all", "12removed"), lty=c("solid"), col=c("red", "blue"))
```

```{r, fig.height=3, fig.width=7}
a <- (Davis$weight - mu) ^ 2 / s2
th <- qchisq(0.99, 1) # 1次のカイ二乗分布の99%点
plot(a, xlab="index", ylab="anomaly score")
lines(0:200,rep(th,length(0:200)),col="red",lty=2)
```

* 異常と見做される点が増えた。  
* 異常なデータ点`r ap[1]`を分布の推定に用いないことで分散が小さくなり、異常度が大きく算出されるようになったためである。

## 多変量正規分布に基づく異常検知

### Davis : 身長と体重の分布
Davisデータの身長と体重の2変量に着目し、これらから異常検知を行ってみよう。

```{r, opts.label='fig_large'}
X <- cbind(Davis$weight, Davis$height)
plot(X[,1], X[,2], pch=20, xlab="weight", ylab="height")
```
* 右下に1点大きく離れた点がある。体重だけで異常検知したときに現れた点12である。

### 分布の推定
データ
$D = \{ x ^{(n)} \in \mathbb{R}^M , n=1 ... N \}$
から多変量正規分布を推定する。平均・分散行列が分かれば良い。
最尤推定量を用いることにしよう。

$$ \hat{\mu} = \frac{1}{N} \sum _{n=1}^{N} x^{(n)} $$
$$ \hat{\Sigma} = \frac{1}{N} \sum _{n=1}^{N} \left(x^{(n)} - \hat{\mu} \right) \left(x^{(n)} - \hat{\mu} \right) ^{\intercal} 
= \frac{1}{N} \tilde{X} \tilde{X} ^ {\intercal} $$

ただし、
$$ \tilde{X} = [x^{(1)} - \hat{\mu}, ..., x^{(N)} - \hat{\mu} ] $$
は中心化されたデータ行列である。
回帰分析の本では、$\tilde{X} ^ \intercal$ をデータ行列として定義することがよく見られるように思う。

```{r }
mu <- colMeans(X) # 平均
Xc <- (t(X) - mu) # 中心化されたデータ行列
Sx <- Xc %*% t(Xc) / nrow(X) # 分散行列
```

* mu = `r mu`
* Sx = `r Sx`

### 異常度の計算
異常度は$-\ln p(x)$から定数倍を調整して、マハラノビス距離
$$ a(x) = (x - \hat{\mu}) ^ {\intercal} \hat{\Sigma }^{-1} (x - \hat{\mu}) $$
として定義する。
この量は$N >> M$のとき、近似的に自由度$M$のカイ二乗分布に従う。

逆行列$\hat{\Sigma }^{-1}$を直接求めず、$\hat{\Sigma }^{-1} (x - \hat{\mu})$を直接求める。
これは$A^{-1}b$は連立1次方程式$Ax = b$ の解であることを用いる。Rのsolveを使えば良い。

```{r }
SxInvXc <- solve(a = Sx, b = Xc)
a <- colSums(Xc * SxInvXc) # 要素毎の積を列毎に和を取ることで, 各点に対する異常度になる

## ちなみにテキストでは説明に反してsolveで逆行列を求めてから計算している。
## (そもそもデータ行列の定義が本文と転置したものにもなっている)
a0 <- colSums((Xc * (solve(Sx) %*% Xc)))
sum(abs(a - a0))
```

```{r, fig.height=3, fig.width=7}
th <- qchisq(0.99, 2) # 自由度Mのカイ二乗分布の99%点
plot(a, xlab="index", ylab="anomaly score")
lines(0:200,rep(th,length(0:200)),col="red",lty=2)
```

* 1つだけ飛び抜けて大きい異常度がある。これは体重のみで求めた異常度でも見つかった点煮対するものであるが、より大きな異常度となっている。身長と体重の組合せの正常なパターンからの乖離が大きいことを検知出来ていると見做せる。
* M次元のどの変数が特に異常であるかについては、何ら情報がない。
これに示唆を与える方法として、マハラノビス＝タグチ法がある。
